# –°–∏—Å—Ç–µ–º–∞ –¥–≤—É—Ö –∞–≥–µ–Ω—Ç–æ–≤ (Agent Orchestrator)

## –û–ø–∏—Å–∞–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –¥–≤—É—Ö –∞–≥–µ–Ω—Ç–æ–≤:
- **PlannerAgent** - —Å–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –∑–∞–¥–∞—á
- **ExecutorAgent** - –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–∞–∂–¥—É—é –∑–∞–¥–∞—á—É –∏–∑ –ø–ª–∞–Ω–∞

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö** (`model/`):
   - `TaskPlan` - –ø–ª–∞–Ω —Å –∑–∞–¥–∞—á–∞–º–∏
   - `TaskItem` - –æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞
   - `ExecutionResult` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   - `TaskPlanSchema` - —Å—Ö–µ–º—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–ª–∞–Ω–æ–≤ (JSON/XML)

2. **–ê–≥–µ–Ω—Ç—ã** (`agent/impl/`):
   - `PlannerAgent` - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞–Ω
   - `ExecutorAgent` - –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

3. **–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä** (`agent/`):
   - `AgentOrchestrator` - –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –∞–≥–µ–Ω—Ç–æ–≤
   - `OrchestratorStep` - —Ç–∏–ø—ã —à–∞–≥–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí ChatService.sendMessageWithOrchestrator()
                    ‚Üì
              AgentOrchestrator.process()
                    ‚Üì
              PlannerAgent.ask() ‚Üí —Å–æ–∑–¥–∞–µ—Ç TaskPlan
                    ‚Üì
              –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏:
                ExecutorAgent.ask() ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á—É
                    ‚Üì
                onStepComplete() ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ —á–∞—Ç
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í –∫–æ–¥–µ

```kotlin
// –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞
val orchestrator = AgentFactory.createAgentOrchestrator()

// –ó–∞–ø—Ä–æ—Å
val request = AgentRequest(
    request = "–°–æ–∑–¥–∞–π –ø—Ä–æ—Å—Ç–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
    context = chatContext,
    parameters = llmParameters
)

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å callback –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
orchestrator.process(request) { step ->
    when (step) {
        is OrchestratorStep.PlanningComplete -> {
            // –ü–ª–∞–Ω —Å–æ–∑–¥–∞–Ω
            println(step.content)
        }
        is OrchestratorStep.TaskComplete -> {
            // –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
            println("–ó–∞–¥–∞—á–∞ ${step.taskId}: ${step.taskTitle}")
            println(step.content)
        }
        is OrchestratorStep.AllComplete -> {
            // –í—Å–µ –∑–∞–¥–∞—á–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã
            println("–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${step.successfulTasks}/${step.totalTasks}")
        }
        is OrchestratorStep.Error -> {
            // –û—à–∏–±–∫–∞
            println("–û—à–∏–±–∫–∞: ${step.error}")
        }
    }
}
```

### –ß–µ—Ä–µ–∑ ChatService

```kotlin
chatService.sendMessageWithOrchestrator(
    userMessage = "–°–æ–∑–¥–∞–π REST API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏",
    project = project,
    onStepComplete = { message ->
        // –ö–∞–∂–¥—ã–π —à–∞–≥ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        displayMessage(message)
    },
    onError = { error ->
        showError(error)
    }
)
```

### –ß–µ—Ä–µ–∑ UI (–∫–æ–º–∞–Ω–¥–∞ /plan)

–í –ø–æ–ª–µ –≤–≤–æ–¥–∞ —á–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–µ—Ñ–∏–∫—Å `/plan`:

```
/plan —Å–æ–∑–¥–∞–π –ø—Ä–æ—Å—Ç–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ñ–æ—Ä–º–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
```

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –°–æ–∑–¥–∞—Å—Ç –ø–ª–∞–Ω –∑–∞–¥–∞—á
2. –í—ã–ø–æ–ª–Ω–∏—Ç –∫–∞–∂–¥—É—é –∑–∞–¥–∞—á—É
3. –û—Ç–æ–±—Ä–∞–∑–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ –≤ —á–∞—Ç–µ

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### PlannerAgent

- **–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç**: –∏–Ω—Å—Ç—Ä—É–∫—Ç–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–ª–∞–Ω—ã
- **–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞**: JSON –∏–ª–∏ XML —Å —á–µ—Ç–∫–æ–π —Å—Ö–µ–º–æ–π
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–ª–∞–Ω–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º

–ü—Ä–∏–º–µ—Ä –ø–ª–∞–Ω–∞ (JSON):
```json
{
  "description": "–°–æ–∑–¥–∞–Ω–∏–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
  "tasks": [
    {
      "id": 1,
      "title": "–°–æ–∑–¥–∞—Ç—å HTML —Å—Ç—Ä—É–∫—Ç—É—Ä—É",
      "description": "–ë–∞–∑–æ–≤–∞—è HTML —Ä–∞–∑–º–µ—Ç–∫–∞",
      "prompt": "–°–æ–∑–¥–∞–π HTML —Ñ–∞–π–ª —Å —Ñ–æ—Ä–º–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏..."
    },
    {
      "id": 2,
      "title": "–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∏–ª–∏ CSS",
      "description": "–°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã",
      "prompt": "–°–æ–∑–¥–∞–π CSS —Ñ–∞–π–ª –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã..."
    }
  ]
}
```

### ExecutorAgent

- **–ò–∑–æ–ª—è—Ü–∏—è**: –ù–ï –≤–∏–¥–∏—Ç –¥—Ä—É–≥–∏–µ –∑–∞–¥–∞—á–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- **–°–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å**: –∫–∞–∂–¥—ã–π –ø—Ä–æ–º–ø—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–µ—Å—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
- **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏

### AgentOrchestrator

- **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**: –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ –ø–æ—Ä—è–¥–∫—É
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤ –∑–∞–¥–∞—á–µ
- **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å**: –∫–∞–∂–¥—ã–π —à–∞–≥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ callback

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ UI

### ChatService

–ú–µ—Ç–æ–¥ `sendMessageWithOrchestrator()` –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `ChatService` –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –æ–±—ã—á–Ω—ã–º `sendMessage()`.

### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —á–∞—Ç–µ

–ö–∞–∂–¥—ã–π —à–∞–≥ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:

1. **PlanningComplete**: 
   ```
   üìã –ü–ª–∞–Ω –∑–∞–¥–∞—á —Å–æ–∑–¥–∞–Ω
   
   –¶–µ–ª—å: –°–æ–∑–¥–∞–Ω–∏–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   
   –ó–∞–¥–∞—á–∏ (3):
   1. –°–æ–∑–¥–∞—Ç—å HTML —Å—Ç—Ä—É–∫—Ç—É—Ä—É
   2. –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∏–ª–∏ CSS
   3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å JavaScript –ª–æ–≥–∏–∫—É
   ```

2. **TaskComplete**:
   ```
   ‚úÖ –ó–∞–¥–∞—á–∞ 1: –°–æ–∑–¥–∞—Ç—å HTML —Å—Ç—Ä—É–∫—Ç—É—Ä—É
   
   [–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏]
   ```

3. **AllComplete**:
   ```
   ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
   
   –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
   - –í—Å–µ–≥–æ –∑–∞–¥–∞—á: 3
   - –£—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: 3
   ```

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –∞–≥–µ–Ω—Ç–∞

1. –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∞—Å—Å, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π `Agent`
2. –î–æ–±–∞–≤—å—Ç–µ –º–µ—Ç–æ–¥ –≤ `AgentFactory`
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ `AgentOrchestrator`

### –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ö–µ–º—ã –ø–ª–∞–Ω–∞

–ò–∑–º–µ–Ω–∏—Ç–µ `TaskPlanSchema` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π:

```kotlin
data class TaskItem(
    val id: Int,
    val title: String,
    val description: String,
    val prompt: String,
    val priority: Int = 0,  // –Ω–æ–≤–æ–µ –ø–æ–ª–µ
    val dependencies: List<Int> = emptyList()  // –Ω–æ–≤–æ–µ –ø–æ–ª–µ
)
```

### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á

–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ `AgentOrchestrator.process()` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `async`:

```kotlin
val results = plan.tasks.map { task ->
    async {
        executorAgent.ask(createRequest(task))
    }
}.awaitAll()
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã:

1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ API –∫–ª—é—á –≤ Settings ‚Üí Tools ‚Üí Ride
2. –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç
3. –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É: `/plan —Å–æ–∑–¥–∞–π –ø—Ä–æ—Å—Ç–æ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä`
4. –ù–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. ExecutorAgent –Ω–µ –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–¥–∞—á
2. –ó–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (–Ω–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
3. –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º
4. –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—Ç–º–µ–Ω—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –∑–∞–¥–∞—á
- [ ] –ü–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏
- [ ] –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞
- [ ] –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–æ–≤
- [ ] –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
