# ROADMAP: RAG-обогащение чата через БД эмбеддингов

Данный документ описывает внедрение Retrieval-Augmented Generation (RAG) в чат плагина: при включённой опции система выполняет поиск релевантных чанков из локальной индексированной БД эмбеддингов и дополняет ими запрос пользователя перед обращением к LLM.

Целевое поведение: при каждом запросе, если опция активна, выполняется поиск top-N релевантных фрагментов проекта и их безопасная интеграция в промпт с учётом лимитов токенов и корректной деградации при ошибках или отсутствии данных.

## Область и критерии приёмки
Функциональность RAG доступна как опциональная настройка. При включении:
- Чат обогащает запрос релевантными фрагментами из индексной БД проекта.
- Лимиты токенов соблюдаются, обогащение не ломает историю и формат ответов.
- При отсутствии БД или недоступности сервиса эмбеддингов поведение корректно деградирует без падений.
- Базовые тесты покрывают поиск, сборку промпта и деградацию.

## Параметры и UX
По умолчанию используются консервативные параметры (настраиваются в Settings → Tools → Ride):
- topK = 5 — финальное число фрагментов после фильтрации
- candidateK = 30 — число кандидатов на первичном поиске перед фильтрацией
- similarityThreshold = 0.25 — порог релевантности [0..1], всё ниже отсеивается
- rerankerStrategy = THRESHOLD — текущая стратегия второго этапа (фильтрация порогом)
- Ограничение по контексту использует существующий параметр `maxContextTokens`.

UX:
- Чекбокс для включения/выключения RAG.
- Поля для настройки topK, candidateK, threshold и стратегии (пока доступен только THRESHOLD).
- Индикация применения RAG в логах/метаданных ответа (вывод параметров стратегии).

## Риски и ограничения
Возможны задержки на больших индексах, несовпадение размерностей эмбеддингов, а также превышение лимитов контекста. Предусмотрены: валидации размерностей, обрезка контента по приоритету релевантности, логирование ключевых этапов retrieval.

---

## Фазы выполнения (чек-листы)

### Фаза 1 — Конфигурация и флаг ✅
- [x] Добавить поле `enableRagEnrichment` в `PluginSettingsState`
- [x] Прокинуть геттер/сеттер в `PluginSettings`
- [x] Добавить чекбокс в `SettingsConfigurable` (вкладка будет выбрана по аналогии с существующими настройками)
- [x] Сохранение/загрузка состояния и reset/apply в UI

### Фаза 2 — Retrieval слой (БД эмбеддингов) ✅
- [x] Использовать `EmbeddingDatabaseService.findSimilarEmbeddings()` для получения topK пар (chunkId, similarity)
- [x] Получать содержимое через `getChunkById()` и формировать список кандидатов
- [x] Фильтровать по `similarityThreshold` и отсекать шум
- [x] Логировать ключевые этапы и параметры (topK, threshold, итоговый счётчик)
- [x] Создать `EmbeddingService` как unified интерфейс для работы с эмбеддингами
- [x] Добавить метод `getFilePathByChunkId()` для получения путей файлов

### Фаза 3 — Интеграция в обработку сообщений ✅
- [x] В `ChatService.sendMessage()` при включённом флаге выполнять retrieval перед обращением к LLM
- [x] Собрать расширенный промпт: системное сообщение с правилами + блок "Retrieved context" + исходный вопрос
- [x] Пробросить метаданные ответа: `ragEnabled`, `retrievedCount`, список источников (файл, строки)
- [x] Минимальная интеграция с оркестратором (по необходимости — отдельной подзадачей)

### Фаза 4 — Контроль токенов и форматирование ✅
- [x] Оценивать длину контекста с учётом `maxContextTokens`
- [x] Обрезать/ранжировать чанки по релевантности до безопасного размера
- [x] Гарантировать корректный формат истории и системного промпта
- [x] Умная усечка чанков с сохранением целостности предложений
- [x] Фильтрация слишком маленьких чанков (шум)

### Фаза 5 — Надёжность и тестирование ✅
- [x] Корректная деградация при отсутствии БД/пустой выдаче/таймаутах эмбеддингов
- [x] Обработка ошибок Ollama сервиса и базы данных
- [x] Юнит-тесты: ранжирование, фильтрация по similarity, сборка промпта
- [x] Интеграционные тесты: путь без БД и с неполными данными
- [x] Таймауты и graceful degradation

### Фаза 6 — Документация и UX ✅
- [x] Обновить `docs/` и `docs/roadmaps/README.md` при необходимости
- [x] Описать включение RAG и процесс индексации (ссылку на уже существующий индексатор)
- [x] Краткая заметка в README о параметрах по умолчанию и ограничениях
- [x] Логирование ключевых операций RAG сервиса
