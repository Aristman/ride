# ROADMAP: Агент индексации эмбеддингов файловой базы проекта

## Описание задачи
Создание нового агента для индексации файловой базы проекта с генерацией эмбеддингов и сохранением в БД для последующего семантического поиска.
Агент не интегрируется в оркестратор, а запускается из настроек (вкладка "Настройки кода")

## Основные требования
- [x] Использование ProjectScannerAgentBridge для доступа к структуре проекта
- [x] Чтение содержимого всех файлов проекта
- [x] Разбивка содержимого на чанки
- [x] Генерация эмбеддингов по чанкам
- [x] Сохранение индекса в SQLite БД
- [x] UI для запуска индексации из настроек (вкладка "Настройки кода")
- [x] Без интеграции в оркестратор и другие агенты (автономный запуск из настроек)

## План разработки

### Этап 1: Архитектура и модели данных
- [x] Создать новый тип агента `EMBEDDING_INDEXER` в `AgentType`
- [x] Создать модели данных для эмбеддингов и чанков
- [x] Спроектировать схему SQLite БД для хранения индекса
- [x] Создать конфигурацию для параметров индексации

### Этап 2: Сервис работы с БД эмбеддингов
- [x] Создать `EmbeddingDatabaseService` для работы с SQLite
- [x] Реализовать создание таблиц и миграции
- [x] Добавить методы для сохранения/поиска эмбеддингов
- [x] Реализовать очистку и переиндексацию

### Этап 3: Сервис генерации эмбеддингов
- [x] Создать `EmbeddingGeneratorService` 
- [x] Интегрировать с LLM провайдером для генерации эмбеддингов
- [x] Реализовать разбивку текста на чанки
- [x] Добавить обработку различных типов файлов

### Этап 4: Основной агент индексации (автономный)
- [x] Создать `EmbeddingIndexerToolAgent`
- [x] Реализовать интеграцию с `ProjectScannerAgentBridge`
- [x] Добавить логику обхода файлов и индексации
- [x] Реализовать инкрементальную индексацию

### Этап 5: UI и настройки (запуск только из настроек)
- [x] Добавить вкладку "Настройки кода" в основной интерфейс
- [x] Создать панель управления индексацией
- [x] Добавить кнопку запуска индексации
- [x] Реализовать отображение прогресса индексации

### Этап 6: Тестирование и конфигурация
- [x] Добавить конфигурацию в `PluginSettings`
- [x] Создать unit тесты для основных компонентов
- [ ] Провести интеграционное тестирование

### Этап 7: Итерация 2 — слежение за изменениями ФС
- [ ] Подписка на изменения файловой системы
- [ ] Инкрементальная переиндексация измененных файлов
- [ ] Опции автоперестроения индекса в настройках

### Этап 8: Документация и финализация
- [ ] Обновить README.md с описанием новой функциональности
- [ ] Создать документацию по API агента
- [ ] Добавить примеры использования
- [ ] Провести финальное тестирование

## Технические детали

### Структура БД (SQLite)
```sql
-- Таблица файлов
CREATE TABLE indexed_files (
    id INTEGER PRIMARY KEY,
    file_path TEXT UNIQUE NOT NULL,
    file_hash TEXT NOT NULL,
    last_modified INTEGER NOT NULL,
    indexed_at INTEGER NOT NULL
);

-- Таблица чанков
CREATE TABLE file_chunks (
    id INTEGER PRIMARY KEY,
    file_id INTEGER NOT NULL,
    chunk_index INTEGER NOT NULL,
    content TEXT NOT NULL,
    start_line INTEGER,
    end_line INTEGER,
    FOREIGN KEY (file_id) REFERENCES indexed_files(id)
);

-- Таблица эмбеддингов
CREATE TABLE embeddings (
    id INTEGER PRIMARY KEY,
    chunk_id INTEGER NOT NULL,
    embedding BLOB NOT NULL,
    dimension INTEGER NOT NULL,
    FOREIGN KEY (chunk_id) REFERENCES file_chunks(id)
);
```

### Основные классы
- `EmbeddingIndexerToolAgent` - основной агент
- `EmbeddingDatabaseService` - работа с БД
- `EmbeddingGeneratorService` - генерация эмбеддингов
- `FileChunkerService` - разбивка файлов на чанки
- `IndexingConfigurable` - UI настройки

### Конфигурация
- Размер чанка (по умолчанию 1000 символов)
- Перекрытие чанков (по умолчанию 200 символов)
- Типы файлов для индексации
- Исключения (паттерны файлов/папок)
- Модель для генерации эмбеддингов

## Ограничения и упрощения
- Используется только SQLite (без внешних векторных БД)
- Простая разбивка по символам (без учета семантики)
- Базовая обработка типов файлов (текстовые)
- Синхронная индексация (без фоновых задач)

## Критерии готовности
- [x] Агент успешно индексирует проект
- [x] БД корректно сохраняет эмбеддинги
- [x] UI позволяет запустить индексацию
- [x] Нет критических ошибок при работе
- [x] Документация обновлена
