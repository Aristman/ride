---
description: Roadmap доработки агентов данных: сканирование → ревью → качество → отчёт
---

# Roadmap: улучшение конвейера данных для отчётов и анализа кода

Цель: обеспечить сквозной конвейер данных между агентами A2A через ШИНУ A2A (MessageBus). Оркестратор только планирует и запускает шаги, НО не передаёт данные между ними напрямую.

- Сканер публикует пути файлов в шину.
- LLM ревьюер и Анализатор качества подписываются на нужные топики и сами читают содержимое файлов; результаты публикуют обратно в шину.
- В события/ответы агентов добавляется признак пригодности данных для UI (чат/отчёт).
- Генератор отчётов подписывается на релевантные топики и собирает данные из шины по `planId`/`stepId`, без хардкода зависимостей.

Архитектурные принципы: SOLID, Clean Architecture (разделение по слоям: use-cases, ports/adapters, infrastructure).

## Фаза 1. Схема сообщений A2A и флаг пригодности к UI
- [ ] Определить единый контракт для полезных нагрузок событий и ответов агентов: `ui_presentable: boolean`, `ui_tags: [string]`.
- [ ] Ввести поля корреляции: `planId`, `stepId`, `agentType`, `topic`.
- [ ] Добавить поддержку флага в: `AgentMessage.Event.metadata` и `AgentResponse.metadata`.
- [ ] Обновить `ChatService` фильтрацию прогресса/деталей: показывать только если `ui_presentable=true` или в white-list событий.
- [ ] Обновить документацию API сообщений/топиков (docs/features / docs/architecture).

## Фаза 2. ProjectScanner → публикация путей в шину
- [ ] Формализовать выход сканера: `paths: [string]`, `root: string`, `generated: boolean`, `ts: long`.
- [ ] Публиковать в топик `project.paths` с `planId`, `stepId`, `agentType=PROJECT_SCANNER`, `ui_presentable=false`.
- [ ] Фильтры сканера в запросе (маски, размер, типы файлов), поддержка пагинации.
- [ ] Оркестратор НЕ переносит данные — только запускает сканер; потребители подписываются на `project.paths`.

## Фаза 3. Orchestrator: только запуск и координация
- [ ] Пробрасывать `planId`/`stepId`/`agentType` в `metadata` всех A2A-запросов.
- [ ] Формировать `data_requirements` как список топиков/агентов для подписки (`topics`: ["project.paths", "review.results", "quality.metrics"], опционально с фильтрами).
- [ ] Не передавать данные напрямую (никаких `dependency_*`). Все данные — через шину.
- [ ] Проверить/обеспечить, что агенты копируют `planId`/`stepId` при публикации в шину.

## Фаза 4. LLMReview: подписка на пути и анализ
- [ ] Подписываться на `project.paths` (фильтр по `planId`).
- [ ] Через `FileOperations`/адаптер читать содержимое указанных путей батчами.
- [ ] Стратегии усечения/сэмплинга (по размеру, изменённости, top-N).
- [ ] Публиковать результат в топик `review.results` (summary, issues, recommendations, per-file notes) с `ui_presentable=true`, `ui_tags=["review"]`.
- [ ] Логировать объём кода, время и лимиты LLM.

## Фаза 5. CodeQuality: подписка и метрики
- [ ] Подписываться на `project.paths` (фильтр по `planId`).
- [ ] Читать содержимое файлов, вычислять метрики (complexity, duplication, coverage placeholders) и собирать проблемы/рекомендации.
- [ ] Публиковать в `quality.metrics` с `ui_presentable=true`, `ui_tags=["quality"]`.
- [ ] Логирование метрик, времени и границ.

## Фаза 6. ReportGenerator: подписка и сбор из шины
- [ ] Подписываться на топики: `review.results`, `quality.metrics` (фильтр по `planId`), при необходимости — на `project.paths` для справочной секции.
- [ ] Фильтровать по `ui_presentable=true` и/или `ui_tags` для включения в отчёт.
- [ ] Генерировать структурированный отчёт (markdown) с разделами: ревью, качество, рекомендации; раздел "файлы" опционален.

## Фаза 7. UI/ChatService и телеметрия
- [ ] В `ChatService` отображать только помеченные `ui_presentable` события.
- [ ] Отображать события по выбранному `planId`.
- [ ] Расширенное логирование причин ошибок: `agentType`, `stepId`, `planId`, сниппеты контента.
- [ ] Метрики: время шагов, объём кода, кол-во файлов, токены.

## Фаза 8. Тесты и валидация
- [ ] Интеграционные тесты: сквозной сценарий (сканирование→ревью→качество→отчёт) на моковом проекте.
- [ ] Контрактные тесты схемы данных для агентов.
- [ ] Нагрузочные проверки на большом количестве файлов (пагинация, лимиты).

## Изменения по кодовой базе (высокоуровнево)
- Orchestrator: `StandaloneA2AOrchestrator` — проброс `planId/stepId/agentType/topic`, формирование `data_requirements` как список топиков; без `dependency_*`.
- Bus: `MessageBus` — рекомендации по топикам: `project.paths`, `review.results`, `quality.metrics`, `report.inputs`.
- Report: `A2AReportGeneratorToolAgent` — подписка на топики, фильтр по `planId`, `ui_presentable/ui_tags`.
- Scanner: `ProjectScannerToolAgent` — публикует пути в `project.paths`, `ui_presentable=false`.
- Review: `A2ALLMReviewToolAgent` — подписка на `project.paths`, чтение, батчи, публикация в `review.results`, `ui_presentable=true`.
- Quality: `A2ACodeQualityToolAgent` — подписка на `project.paths`, публикация в `quality.metrics`, `ui_presentable=true`.
- Chat/UI: `ChatService` — фильтрация событий и улучшенные сообщения об ошибках (добавлено).

## Риски и управление
- Лимиты LLM и объём кода → батчирование и эвристики приоритизации.
- Производительность IO при чтении большого числа файлов → порог на размер, параллелизм с ограничениями.
- Консистентность схемы данных → единый контракт и контрактные тесты.

## Критерии готовности (Definition of Done)
- Сквозной прогон генерирует отчёт с реальными данными ревью и качества.
- В UI выводятся только помеченные события/данные.
- Интеграционные тесты зелёные.
- Документация обновлена (schema + pipeline + README).
