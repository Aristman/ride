# Roadmap: Интеграция MCP серверов

## Описание
Реализация функциональности подключения MCP (Model Context Protocol) серверов к плагину Ride. Подключение осуществляется через конфигурационный файл `.ride/mcp.json`, с отображением статуса подключений и доступных методов в UI.

## Задачи

### 1. Модели данных для MCP
- [x] Создать `MCPServerConfig` - модель конфигурации MCP сервера
  - Поля: `name`, `type` (stdio/http), `command`, `args`, `env`, `url`, `enabled`
- [x] Создать `MCPServerStatus` - модель статуса подключения
  - Поля: `name`, `connected`, `error`, `methods`, `lastConnected`
- [x] Создать `MCPMethod` - модель метода MCP сервера
  - Поля: `name`, `description`, `parameters`, `schema`
- [x] Создать `MCPSettings` - модель настроек MCP
  - Поля: `servers: List<MCPServerConfig>`

### 2. Конфигурационный файл `.ride/mcp.json`
- [x] Создать `MCPConfigService` для работы с конфигурацией
  - Метод `loadConfig()` - загрузка из `.ride/mcp.json`
  - Метод `saveConfig()` - сохранение в `.ride/mcp.json`
  - Метод `validateConfig()` - валидация конфигурации
  - Метод `getDefaultConfig()` - создание дефолтной конфигурации
- [x] Добавить автоматическое создание `.ride/mcp.json` при первом запуске
- [ ] Добавить JSON Schema для валидации конфигурации

### 3. MCP Client - подключение к серверам
- [x] Создать `MCPClient` интерфейс
  - Метод `connect()` - подключение к серверу
  - Метод `disconnect()` - отключение от сервера
  - Метод `isConnected()` - проверка статуса
  - Метод `listMethods()` - получение списка методов
  - Метод `callMethod()` - вызов метода сервера
- [x] Реализовать `StdioMCPClient` для stdio подключения
  - Запуск процесса с command/args
  - JSON-RPC коммуникация через stdin/stdout
  - Обработка stderr для логирования
- [x] Реализовать `HttpMCPClient` для HTTP подключения
  - HTTP клиент для REST API
  - JSON-RPC over HTTP
- [x] Добавить `MCPClientFactory` для создания клиентов по типу

### 4. MCP Connection Manager
- [x] Создать `MCPConnectionManager` сервис
  - Метод `initializeConnections()` - инициализация всех серверов из конфига
  - Метод `getServerStatus()` - получение статуса сервера
  - Метод `getAllStatuses()` - получение статусов всех серверов
  - Метод `reconnectServer()` - переподключение сервера
  - Метод `refreshMethods()` - обновление списка методов
- [ ] Добавить автоматическое переподключение при ошибках
- [x] Добавить кэширование списка методов
- [x] Добавить логирование событий подключения/отключения

### 5. UI - Страница настроек MCP
- [x] Создать `MCPSettingsPanel` - панель настроек MCP
  - Таблица со списком MCP серверов
  - Колонки: Name, Type, Status (Connected/Disconnected), Actions
  - Кнопка "Add Server" для добавления нового сервера
  - Кнопка "Edit" для редактирования конфигурации
  - Кнопка "Delete" для удаления сервера
  - Кнопка "Test Connection" для проверки подключения
- [x] Создать `MCPServerDialog` - диалог добавления/редактирования сервера
  - Поля: Name, Type (dropdown), Command, Args, Env, URL
  - Валидация полей
  - Кнопка "Test" для проверки подключения
- [x] Добавить визуальные индикаторы статуса (зеленый/красный)
- [ ] Добавить tooltip с информацией об ошибке при наведении на статус

### 6. UI - Список методов MCP сервера
- [ ] Создать expandable/collapsible список серверов
  - При клике на имя сервера - раскрывается список методов
  - Отображение методов только для подключенных серверов
- [ ] Создать `MCPMethodPanel` - панель отображения методов
  - Список методов с названием и описанием
  - Кнопка "Call" для вызова метода
  - Отображение параметров метода
- [ ] Создать `MCPMethodCallDialog` - диалог вызова метода
  - Динамическая форма на основе схемы параметров
  - Валидация параметров
  - Отображение результата вызова

### 7. Обработка ошибок и логирование
- [ ] Добавить обработку ошибок подключения
  - Timeout при подключении
  - Ошибки запуска процесса (stdio)
  - Ошибки HTTP запросов
- [ ] Добавить детальное логирование
  - Логи подключения/отключения
  - Логи вызовов методов
  - Логи ошибок
- [ ] Добавить уведомления пользователю
  - Notification при ошибке подключения
  - Notification при успешном подключении
  - Notification при изменении конфигурации

### 8. Тестирование
- [ ] Unit тесты для моделей данных
  - `MCPServerConfig`, `MCPServerStatus`, `MCPMethod`
- [ ] Unit тесты для `MCPConfigService`
  - Загрузка/сохранение конфигурации
  - Валидация конфигурации
- [ ] Unit тесты для `MCPClient` с mock серверами
  - Подключение/отключение
  - Вызов методов
- [ ] Unit тесты для `MCPConnectionManager`
  - Управление подключениями
  - Обработка ошибок
- [ ] Integration тесты с реальным MCP сервером
  - Подключение через stdio
  - Подключение через HTTP
  - Вызов методов
- [ ] UI тесты для `MCPSettingsPanel`
  - Добавление/редактирование/удаление серверов
  - Отображение статусов

### 9. Документация
- [ ] Создать `docs/features/mcp-integration.md`
  - Описание функциональности
  - Примеры конфигурации `.ride/mcp.json`
  - Примеры использования
- [ ] Обновить `README.md`
  - Добавить раздел о MCP интеграции
  - Добавить скриншоты UI
- [ ] Создать `docs/api/mcp-protocol.md`
  - Описание протокола MCP
  - Спецификация JSON-RPC
  - Примеры запросов/ответов
- [ ] Добавить примеры MCP серверов в документацию

## Приоритеты

**High Priority:**
- Задачи 1-4 (Модели, конфигурация, клиент, менеджер)
- Задача 5 (UI настроек)

**Medium Priority:**
- Задача 6 (UI методов)
- Задача 7 (Обработка ошибок)

**Low Priority:**
- Задача 8 (Тестирование)
- Задача 9 (Документация)

**Отложено (в бэклоге):**
- Интеграция MCP с Agent - автоматический вызов tools (см. BACKLOG.md)

## Технические детали

### Пример `.ride/mcp.json`
```json
{
  "servers": [
    {
      "name": "filesystem",
      "type": "stdio",
      "command": "node",
      "args": ["path/to/mcp-server-filesystem/dist/index.js"],
      "env": {},
      "enabled": true
    },
    {
      "name": "github",
      "type": "http",
      "url": "http://localhost:3000/mcp",
      "enabled": true
    }
  ]
}
```

### JSON-RPC протокол
```json
// Запрос списка методов
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/list"
}

// Ответ со списком методов
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "tools": [
      {
        "name": "read_file",
        "description": "Read file contents",
        "inputSchema": {
          "type": "object",
          "properties": {
            "path": {"type": "string"}
          }
        }
      }
    ]
  }
}

// Вызов метода
{
  "jsonrpc": "2.0",
  "id": 2,
  "method": "tools/call",
  "params": {
    "name": "read_file",
    "arguments": {
      "path": "/path/to/file.txt"
    }
  }
}
```

## Зависимости

### Новые зависимости
- JSON Schema валидация (возможно `org.everit.json:json-schema`)
- Process management (встроенный `ProcessBuilder`)
- HTTP клиент (уже используется `java.net.http.HttpClient`)

## Риски и ограничения

1. **Безопасность**: Запуск внешних процессов может быть небезопасен
   - Решение: Валидация команд, sandbox для процессов
2. **Производительность**: Множество подключений может замедлить IDE
   - Решение: Ленивая инициализация, кэширование
3. **Совместимость**: Разные версии MCP протокола
   - Решение: Версионирование протокола, fallback механизмы

## Оценка времени

- **Модели и конфигурация**: 4 часа
- **MCP Client**: 8 часов
- **Connection Manager**: 6 часов
- **UI настроек**: 8 часов
- **UI методов**: 6 часов
- **Обработка ошибок**: 4 часа
- **Тестирование**: 8 часов
- **Документация**: 4 часа

**Итого**: ~48 часов (~6 рабочих дней)

## Статус

- [ ] Roadmap создан и утвержден
- [ ] Разработка начата
- [ ] Разработка завершена
- [ ] Тестирование пройдено
- [ ] Документация обновлена
- [ ] Фича готова к релизу

---

**Дата создания**: 2025-10-13  
**Версия**: 1.0  
**Автор**: Cascade AI  
**Статус**: Ожидает утверждения
