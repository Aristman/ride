# Роадмап: Разработка расширенного агента-оркестратора

## 📋 Обзор

Документ описывает план по развитию существующего `AgentOrchestrator` в полноценную систему управления мультиагентными
флоу с интерактивностью, стейт-машиной и Tool Agents.

## 🎯 Цели разработки

### Основные задачи

- [ ] Создать агента-адаптера между мультиагентной системой и пользователем
- [ ] Определять общий план работы (что нужно сделать)
- [ ] Организовывать реализацию в частности (как это сделать)
- [ ] Управлять флоу разработки с интерактивностью
- [ ] Интегрировать агентов-исполнителей для анализа кода

### Гипотеза: Стейт-машина

**Статус: ✅ Подтверждена**

Стейт-машина целесообразна для:

- Управления жизненным циклом планов выполнения
- Обработки пользовательских взаимодействий
- Восстановления после ошибок
- Валидации переходов между состояниями

## 📊 Текущее состояние

### Существующая архитектура

```
ChatAgent → AgentOrchestrator → PlannerAgent → ExecutorAgent
                                      ↓
                                  TaskPlan
                                      ↓
                                  TaskItem[]
```

### Что уже есть

- ✅ `AgentOrchestrator` - базовая координация PlannerAgent и ExecutorAgent
- ✅ `PlannerAgent` - создание планов задач
- ✅ `ExecutorAgent` - выполнение отдельных задач
- ✅ `TaskPlan` и `TaskItem` - модели для планов
- ✅ `OrchestratorStep` - события выполнения
- ✅ `UncertaintyAnalyzer` - анализ неопределенности
- ✅ `CodeAnalysisAgent` - интерфейс для анализа кода

### Что отсутствует

- ❌ **RequestAnalyzer** - анализ и классификация запросов
- ❌ **Tool Agents** - специализированные агенты-инструменты
- ❌ **State Machine** - управление состояниями плана
- ❌ **PlanStorage** - персистентность планов
- ❌ **ProgressTracker** - детальное отслеживание прогресса
- ❌ **Интерактивность** - паузы для пользовательского ввода
- ❌ **Параллельное выполнение** - независимые шаги одновременно
- ❌ **Контекстная передача** - результаты между шагами

## 🏗️ Архитектурное решение

### Расширенная архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                        ChatAgent                            │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              EnhancedAgentOrchestrator                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ Request      │  │ Plan         │  │ State        │       │
│  │ Analyzer     │→ │ Generator    │→ │ Machine      │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│                                             │               │
│  ┌──────────────┐  ┌──────────────┐         │               │
│  │ Plan         │  │ Progress     │         │               │
│  │ Storage      │  │ Tracker      │         │               │
│  └──────────────┘  └──────────────┘         │               │
└─────────────────────────────────────────────┼───────────────┘
                                              │
                         ┌────────────────────┴────────────────────┐
                         │          Plan Executor                  │
                         │  (с поддержкой параллелизма)            │
                         └────────────────────┬────────────────────┘
                                              │
                ┌─────────────────────────────┼─────────────────────────────┐
                │                             │                             │
                ▼                             ▼                             ▼
    ┌───────────────────┐       ┌───────────────────┐       ┌───────────────────┐
    │  Tool Agents      │       │  Code Analysis    │       │  User Interaction │
    │  Registry         │       │  Tool Agents      │       │  Agent            │
    └───────────────────┘       └───────────────────┘       └───────────────────┘
            │                            │
            │                            ├─ ProjectScannerToolAgent
            │                            ├─ BugDetectionToolAgent
            │                            ├─ CodeQualityToolAgent
            │                            ├─ ArchitectureToolAgent
            │                            └─ CodeChunkerToolAgent
            │
            └─ Другие Tool Agents (FileOperations, Git, etc.)
```

### Стейт-машина плана выполнения

```
    CREATED
       │
       ▼
   ANALYZING ──────────► REQUIRES_INPUT
       │                      │
       ▼                      │
  IN_PROGRESS ◄───────────────┘
       │
       ├──────► PAUSED ────► RESUMED ──┐
       │                                │
       ├────────────────────────────────┘
       │
       ├──────► COMPLETED
       │
       └──────► FAILED ──────► RETRY ──┐
                                        │
                                        └──► IN_PROGRESS
```

## 📝 План реализации

### Этап 1: Расширение базовой архитектуры (2-3 недели)

#### 1.1 Создание RequestAnalyzer

- [ ] Создать интерфейс `RequestAnalyzer`
- [ ] Реализовать `LLMRequestAnalyzer` с использованием LLM
- [ ] Добавить классификацию типов задач
- [ ] Извлечение контекста и параметров из запроса
- [ ] Определение необходимых Tool Agents

#### 1.2 Разработка State Machine

- [ ] Создать `PlanStateMachine` для управления состояниями
- [ ] Определить все возможные состояния плана
- [ ] Реализовать валидацию переходов
- [ ] Добавить обработку событий (events)
- [ ] Интегрировать с `AgentOrchestrator`

#### 1.3 Создание PlanStorage

- [ ] Разработать интерфейс `PlanStorage`
- [ ] Реализовать `InMemoryPlanStorage` для MVP
- [ ] Добавить сериализацию/десериализацию планов
- [ ] Реализовать `PersistentPlanStorage` с сохранением на диск
- [ ] Добавить версионирование планов

#### 1.4 Разработка ProgressTracker

- [ ] Создать `ProgressTracker` для детального отслеживания
- [ ] Добавить расчет прогресса выполнения (%)
- [ ] Реализовать оценку времени завершения (ETA)
- [ ] Добавить события прогресса для UI
- [ ] Интегрировать с `OrchestratorStep`

### Этап 2: Tool Agents на основе CodeAnalysisAgent (2-3 недели)

#### 2.1 Создание базового интерфейса ToolAgent

- [ ] Определить интерфейс `ToolAgent`
- [ ] Создать базовые модели (`StepInput`, `StepOutput`, `StepResult`)
- [ ] Реализовать `ToolAgentRegistry` для регистрации агентов
- [ ] Добавить систему capabilities для агентов

#### 2.2 Декомпозиция CodeAnalysisAgent на Tool Agents

- [ ] Создать `ProjectScannerToolAgent` (сканирование файлов)
- [ ] Создать `CodeChunkerToolAgent` (разбиение больших файлов)
- [ ] Создать `BugDetectionToolAgent` (поиск багов)
- [ ] Создать `CodeQualityToolAgent` (анализ качества)
- [ ] Создать `ArchitectureToolAgent` (анализ архитектуры)

#### 2.3 Создание ToolAgentRegistry

- [ ] Реализовать регистрацию и управление Tool Agents
- [ ] Добавить автообнаружение агентов
- [ ] Создать фабрику для создания агентов
- [ ] Интегрировать с `EnhancedAgentOrchestrator`

### Этап 3: Интерактивность и пользовательское взаимодействие (2-3 недели)

#### 3.1 Создание UserInteractionAgent

- [ ] Разработать `UserInteractionAgent` для диалогов
- [ ] Реализовать паузы выполнения для ввода
- [ ] Добавить валидацию пользовательского ввода
- [ ] Создать типовые шаблоны вопросов

#### 3.2 Интеграция с ChatAgent

- [ ] Расширить `ChatAgent` для обработки интерактивных планов
- [ ] Добавить UI элементы для пользовательского ввода
- [ ] Реализовать возобновление плана после ввода
- [ ] Создать историю взаимодействий

#### 3.3 Адаптивные планы выполнения

- [ ] Реализовать изменение плана на основе результатов
- [ ] Добавить условное выполнение шагов
- [ ] Создать систему приоритизации задач
- [ ] Интегрировать с `UncertaintyAnalyzer`

### Этап 4: Расширенное выполнение планов (2-3 недели)

#### 4.1 Параллельное выполнение

- [ ] Реализовать граф зависимостей (DAG)
- [ ] Добавить параллельное выполнение независимых шагов
- [ ] Создать пул потоков для выполнения
- [ ] Обработка ошибок в параллельных задачах

#### 4.2 Контекстная передача между шагами

- [ ] Реализовать передачу результатов между шагами
- [ ] Создать систему трансформации данных
- [ ] Добавить валидацию входных/выходных данных
- [ ] Кэширование промежуточных результатов

#### 4.3 Обработка ошибок и retry-логика

- [ ] Реализовать retry с экспоненциальным backoff
- [ ] Добавить транзакционность для откатов
- [ ] Создать систему fallback стратегий
- [ ] Логирование и диагностика ошибок

### Этап 5: Интеграция и оптимизация (2-3 недели)

#### 5.1 Интеграция с существующими компонентами

- [ ] Интегрировать с `UncertaintyAnalyzer`
- [ ] Связать с `CodeAnalysisAgent`
- [ ] Обеспечить совместимость с `PlannerAgent` и `ExecutorAgent`
- [ ] Создать миграционный путь от старого к новому

#### 5.2 Оптимизация производительности

- [ ] Кэширование результатов анализа
- [ ] Оптимизация работы с большими проектами
- [ ] Ленивая загрузка компонентов
- [ ] Профилирование и устранение узких мест

#### 5.3 Тестирование

- [ ] Unit тесты для всех компонентов
- [ ] Интеграционные тесты для флоу
- [ ] Тесты стейт-машины
- [ ] Нагрузочное тестирование

#### 5.4 Документация

- [ ] Обновить архитектурную документацию
- [ ] Создать примеры использования
- [ ] Написать гайд по созданию Tool Agents
- [ ] Обновить README.md

## 🎯 Критерии успеха

### Функциональные

- [ ] Успешное выполнение сложных многошаговых задач
- [ ] Интерактивность с пользователем в процессе выполнения
- [ ] Надежное восстановление после ошибок
- [ ] Интеграция с существующими агентами

### Нефункциональные

- [ ] Время отклика < 2 секунд на типичных задачах
- [ ] Стабильная работа без падений
- [ ] Положительный UX фидбек от пользователей
- [ ] Покрытие тестами > 80%

## 📊 Оценка сроков

| Этап                             | Длительность     | Приоритет |
|----------------------------------|------------------|-----------|
| Этап 1: Базовая архитектура      | 2-3 недели       | Высокий   |
| Этап 2: Tool Agents              | 2-3 недели       | Высокий   |
| Этап 3: Интерактивность          | 2-3 недели       | Средний   |
| Этап 4: Расширенное выполнение   | 2-3 недели       | Средний   |
| Этап 5: Интеграция и оптимизация | 2-3 недели       | Низкий    |
| **Итого**                        | **10-15 недель** |           |

## 🚀 Следующие шаги

1. Утвердить roadmap с командой
2. Начать с Этапа 1: Базовая архитектура
3. Создать MVP с простым типом задач
4. Постепенно расширять функциональность
5. Интегрировать с существующими инструментами

---

*Документ создан: 2025-10-20*
*Статус: На утверждение*
