# –≠—Ç–∞–ø 3: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ

**–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 2-3 –Ω–µ–¥–µ–ª–∏  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** Phase 1, Phase 2

---

## üéØ –¶–µ–ª–∏ —ç—Ç–∞–ø–∞

–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏:
- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ü–∞—É–∑—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ChatAgent

---

## üìã –ó–∞–¥–∞—á–∏

### 3.1 UserInteractionAgent
- [x] –†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å `UserInteractionAgent` –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–∞—É–∑—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
- [x] –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
- [x] –°–æ–∑–¥–∞—Ç—å —Ç–∏–ø–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã –≤–æ–ø—Ä–æ—Å–æ–≤ (confirmation, choice, input)
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
- [x] –î–æ–±–∞–≤–∏—Ç—å timeout –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞

### 3.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ChatAgent
- [ ] –†–∞—Å—à–∏—Ä–∏—Ç—å `ChatAgent` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å UI —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ (resumePlan)
- [x] –°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —á–∞—Ç–µ
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

### 3.3 –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–Ω—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- [x] –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —à–∞–≥–æ–≤ (if/else)
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å `UncertaintyAnalyzer` –¥–ª—è –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —à–∞–≥–æ–≤ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ü–∏–∫–ª–æ–≤ (retry, loop)

---

## üìö –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### UserInteractionAgent
```kotlin
class UserInteractionAgent : ToolAgent {
    override val agentType = AgentType.USER_INTERACTION
    override val capabilities = setOf("user_input", "confirmation", "choice_selection")
    
    override suspend fun executeStep(step: PlanStep, context: ExecutionContext): StepResult {
        val promptType = step.input.getString("prompt_type") ?: "confirmation"
        val message = step.input.getString("message") ?: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ"
        val options = step.input.getList<String>("options") ?: listOf("–î–∞", "–ù–µ—Ç")
        
        return StepResult.requiresInput(
            prompt = buildPrompt(promptType, message, options)
        )
    }
}
```

### –¢–∏–ø—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
```kotlin
enum class InteractionType {
    CONFIRMATION,    // –î–∞/–ù–µ—Ç
    CHOICE,          // –í—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞
    INPUT,           // –°–≤–æ–±–æ–¥–Ω—ã–π –≤–≤–æ–¥
    MULTI_CHOICE     // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
}

data class UserPrompt(
    val type: InteractionType,
    val message: String,
    val options: List<String> = emptyList(),
    val defaultValue: String? = null,
    val validator: ((String) -> Boolean)? = null,
    val timeout: Long? = null
)
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ChatAgent
```kotlin
class EnhancedChatAgent(
    private val baseAgent: ChatAgent,
    private val orchestrator: EnhancedAgentOrchestrator
) : ChatAgent by baseAgent {
    
    override suspend fun ask(request: AgentRequest): AgentResponse {
        val resumePlanId = request.parameters["resume_plan_id"] as? String
        
        return if (resumePlanId != null) {
            // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–ª–∞–Ω
            orchestrator.resumePlan(resumePlanId, request.request)
        } else if (isComplexTask(request.request)) {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø–ª–∞–Ω
            orchestrator.orchestrate(UserRequest.fromAgentRequest(request))
        } else {
            // –û–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            baseAgent.ask(request)
        }
    }
}
```

---

## üé® UI/UX

### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

```
–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∫–æ–¥ –Ω–∞ –±–∞–≥–∏...
‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ 15 –ø—Ä–æ–±–ª–µ–º:
- 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö
- 7 –≤—ã—Å–æ–∫–∏—Ö
- 5 —Å—Ä–µ–¥–Ω–∏—Ö

‚ùì –ù–∞–π–¥–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. FileService.kt:45 - Potential NPE
2. DatabaseManager.kt:123 - Resource leak
3. CacheManager.kt:67 - Race condition

–ò—Å–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã?

[–î–∞] [–ù–µ—Ç] [–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏]
```

### –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
üìã –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: –ê–Ω–∞–ª–∏–∑ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ 60%

‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (–∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞ 2.3s)
‚úÖ –ü–æ–∏—Å–∫ –±–∞–≥–æ–≤ (–∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞ 15.7s)
‚è∏Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...
‚è≥ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤ (–æ–∂–∏–¥–∞–µ—Ç)
‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ (–æ–∂–∏–¥–∞–µ—Ç)

ETA: ~30 —Å–µ–∫—É–Ω–¥
```

---

## üîÑ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–Ω—ã

### –£—Å–ª–æ–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
```kotlin
data class ConditionalStep(
    val condition: (ExecutionContext) -> Boolean,
    val thenStep: PlanStep,
    val elseStep: PlanStep? = null
)

class AdaptivePlanExecutor {
    suspend fun executeConditionalStep(
        conditional: ConditionalStep,
        context: ExecutionContext
    ): StepResult {
        val step = if (conditional.condition(context)) {
            conditional.thenStep
        } else {
            conditional.elseStep ?: return StepResult.success(StepOutput.empty())
        }
        
        return executeStep(step, context)
    }
}
```

### –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞
```kotlin
class DynamicPlanModifier {
    fun addStep(plan: ExecutionPlan, step: PlanStep, afterStepId: String): ExecutionPlan {
        val steps = plan.steps.toMutableList()
        val index = steps.indexOfFirst { it.id == afterStepId }
        
        if (index >= 0) {
            steps.add(index + 1, step)
        }
        
        return plan.copy(steps = steps)
    }
    
    fun removeStep(plan: ExecutionPlan, stepId: String): ExecutionPlan {
        return plan.copy(
            steps = plan.steps.filter { it.id != stepId }
        )
    }
    
    fun replaceStep(plan: ExecutionPlan, stepId: String, newStep: PlanStep): ExecutionPlan {
        return plan.copy(
            steps = plan.steps.map { if (it.id == stepId) newStep else it }
        )
    }
}
```

---

## üß™ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π
```kotlin
// –°–æ–∑–¥–∞–µ–º —à–∞–≥ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
val confirmStep = PlanStep(
    id = "confirm_fix",
    description = "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–≥–æ–≤",
    agentType = AgentType.USER_INTERACTION,
    input = StepInput.mapOf(
        "prompt_type" to "confirmation",
        "message" to "–ù–∞–π–¥–µ–Ω–æ 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º—ã. –ò—Å–ø—Ä–∞–≤–∏—Ç—å?",
        "options" to listOf("–î–∞", "–ù–µ—Ç", "–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏"),
        "data" to criticalFindings
    ),
    dependencies = setOf("analyze_bugs")
)
```

### –ü—Ä–∏–º–µ—Ä 2: –í—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞
```kotlin
val choiceStep = PlanStep(
    id = "select_refactoring",
    description = "–í—ã–±–æ—Ä —Ç–∏–ø–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞",
    agentType = AgentType.USER_INTERACTION,
    input = StepInput.mapOf(
        "prompt_type" to "choice",
        "message" to "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:",
        "options" to listOf(
            "–ò–∑–≤–ª–µ—á—å –º–µ—Ç–æ–¥",
            "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å",
            "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –¥—Ä—É–≥–æ–π –ø–∞–∫–µ—Ç",
            "–û—Ç–º–µ–Ω–∏—Ç—å"
        )
    ),
    dependencies = setOf("analyze_code")
)
```

### –ü—Ä–∏–º–µ—Ä 3: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω
```kotlin
// –ü–ª–∞–Ω –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
val adaptivePlan = ExecutionPlan(
    steps = listOf(
        scanStep,
        analyzeStep,
        ConditionalStep(
            condition = { ctx ->
                val findings = ctx.getStepResult("analyze")?.getList<Finding>("findings")
                findings?.any { it.severity == Severity.CRITICAL } == true
            },
            thenStep = confirmFixStep,
            elseStep = reportStep
        )
    )
)
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [x] UserInteractionAgent —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] ChatAgent –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–Ω—ã
- [ ] UI –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- [ ] –ü–ª–∞–Ω—ã –º–æ–∂–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª—è—Ç—å
- [x] –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–Ω—ã –∏–∑–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- [x] –£—Å–ª–æ–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [x] –ò—Å—Ç–æ—Ä–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- [x] Unit –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã >80% –ø–æ–∫—Ä—ã—Ç–∏—è
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

---

## üìñ –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [Phase 2: Tool Agents](phase-2-tool-agents.md)
- [Phase 4: Advanced Execution](phase-4-advanced-execution.md)
- [Uncertainty Analysis Feature](../../features/FEATURE_UNCERTAINTY_ANALYSIS.md)

---

*–°–æ–∑–¥–∞–Ω–æ: 2025-10-20*
