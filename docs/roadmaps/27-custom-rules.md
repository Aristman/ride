# ROADMAP: Настраиваемые правила (md) для подмешивания к системному промпту

Описание фичи: поддержать подключаемые правила (заранее сохраненные промпты) из файлов Markdown, которые автоматически добавляются к системному промпту при каждом запросе пользователя.

- Форматы: только `.md` файлы
- Источники правил:
  - Глобальные: `~/.ride/rules/`
  - Проектные: `<PROJECT_ROOT>/.ride/rules/`
- Приоритет: сначала проектные, затем глобальные (конкатенация; конфликтов нет)
- Открытие/редактирование: через Settings → Ride

## Фазы выполнения

### Фаза 1 — Базовая интеграция (MVP)
- [ ] Создать сервис `RulesService` (Application Service)
- [ ] Реализовать чтение `*.md` из `~/.ride/rules/` и `<PROJECT_ROOT>/.ride/rules/`
- [ ] Конкатенировать содержимое в один блок с разделителями, добавить заголовки источников
- [ ] Интегрировать в `ChatAgent.ask()` подмешивание правил к системному промпту
- [ ] Добавить в Settings секцию "Rules":
  - [ ] Кнопка "Открыть глобальные правила" (создать папку при отсутствии)
  - [ ] Кнопка "Открыть правила проекта" (создать папку при отсутствии)
- [ ] Smoke-тесты: ручная проверка загрузки правил и отображения в промпте

### Фаза 2 — UX улучшения
- [ ] Показать превью активных правил в Settings (read-only textarea)
- [ ] Кнопки "Создать шаблон правила" (pre-filled md)
- [ ] Переключатель включения/отключения правил (feature flag)

### Фаза 3 — Кеширование и производительность
- [ ] Кеширование по mtime директорий и lazy reload
- [ ] Ограничение общего объема подключаемых правил (по символам)
- [ ] Тримминг/нормализация (удаление лишних пробелов, BOM)

### Фаза 4 — Тестирование и документация
- [ ] Unit-тесты `RulesService`
- [ ] Интеграционные тесты ChatAgent с загруженными правилами
- [ ] Обновление `docs/README.md` и примеров

## Детали реализации

- Сервис: `ru.marslab.ide.ride.rules.RulesService`
  - `fun composeSystemPromptWithRules(basePrompt: String, project: Project?): String`
  - Читает файлы в алфавитном порядке; разделитель: `\n\n---\n<!-- rules: <scope> -->\n\n`
  - Безопасность: игнорирует бинарные/большие файлы, ловит исключения ввода-вывода

- Интеграция в `ChatAgent.ask()`:
  - После `buildSystemPrompt()` вызвать `composeSystemPromptWithRules(...)`
  - Использовать результат в `manageContext(...)` и в `llmProvider.sendRequest(...)`

- Settings (в `SettingsConfigurable`):
  - Группа "Rules" с кнопками:
    - "Open Global Rules" → `~/.ride/rules/`
    - "Open Project Rules" → `<PROJECT_ROOT>/.ride/rules/`
  - При отсутствии директорий — создать
  - Открытие через `RevealFileAction.openDirectory(File, Project?)`

## Риски и ограничения
- Слишком большие правила могут взрывать лимит токенов → добавить предупреждение/ограничения в Фазе 3
- Проектные правила зависят от выбранного проекта в IDE Settings → используем первый открытый проект (`ProjectManager`), уточнить UX позже

## Артефакты
- Файлы правил-шаблонов (пример):
  - `~/.ride/rules/formatting.md`
  - `<PROJECT_ROOT>/.ride/rules/conventions.md`
