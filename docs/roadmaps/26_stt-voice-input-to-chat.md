# ROADMAP: Голосовой ввод (STT) и отправка в чат

## Обзор
Цель — добавить в чат кнопку записи голоса, распознать речь через Yandex SpeechKit (STT v2) и подставить распознанный текст в поле ввода. Реализация изолирована, следует SOLID и Clean Architecture (domain, data/infrastructure, presentation). Стек UI — плагин IDE (реализация кнопки и состояний в плагине).

## Бизнес-цели
- Сократить время ввода запросов за счёт голосового ввода.
- Повысить удобство использования чата в IDE-плагине.
- Подготовить основу для дальнейших голосовых фич.

## Ключевые требования
- Кнопка микрофона справа под полем ввода.
- По нажатию — старт записи, иконка меняется на «Стоп».
- По стопу — фоновое распознавание (индикация «Распознавание…»).
- Результат: текст подставляется в поле ввода (без авто-отправки).
- Формат записи как в примере сервиса: предпочтительно `ogg/opus`; поддержка `wav` с извлечением `PCM (lpcm)` при необходимости.
- Авторизация Yandex SpeechKit: `Bearer (YANDEX_IAM_TOKEN)` или `Api-Key + x-folder-id`.
- Язык по умолчанию: `ru-RU`.

## Архитектура (Clean Architecture)
- Domain:
  - Интерфейс `SpeechToTextService`:
    - `startRecording(config: SttConfig)`
    - `stopAndRecognize(): Result<String>`
    - `cancel()`
  - DTO: `SttConfig(lang = "ru-RU", format = oggopus|lpcm, sampleRate = 16000, channels = 1)`, `RecordingState`.
- Data/Infrastructure:
  - `YandexSpeechSttService` (REST v2): oggopus/lpcm; WAV→PCM (парсер заголовка WAV, выбор `sampleRateHertz`).
  - Модуль записи аудио (микрофон) с параметрами 16kHz mono и сохранением в ogg/opus.
  - Провайдер токенов/ключей.
- Presentation (плагин):
  - Кнопка микрофона и индикаторы: Idle → Recording → Recognizing → Ready/Error.
  - Интеграция с полем ввода чата: подстановка текста после распознавания.

## Конфигурация
- `YANDEX_IAM_TOKEN` или `YANDEX_API_KEY` + `YANDEX_FOLDER_ID` (для Api-Key).
- Язык: `ru-RU` (по умолчанию в конфиге сервиса, возможность переопределения).
- Таймауты HTTP: стандартные; SLA распознавания 3–5 сек — приемлемо.

## Фазы выполнения

### Фаза 1. Подготовка
- [ ] Утвердить данный ROADMAP
- [ ] Создать интерфейсы в `domain` (`SpeechToTextService`, `SttConfig`, ошибки)
- [ ] Определить параметры записи и стратегии форматов (oggopus по умолчанию)

### Фаза 2. Инфраструктура STT (Yandex)
- [ ] Реализовать `YandexSpeechSttService` (авторизация Bearer/Api-Key, форматы oggopus/lpcm, WAV→PCM)
- [ ] Обработка ошибок/таймаутов, пустых результатов
- [ ] Логи (debug), трейсинг ключевых шагов
- [ ] Unit-тесты парсинга WAV и построения запросов

### Фаза 3. Запись аудио
- [ ] Реализовать запись с микрофона (16kHz mono, огг/опус)
- [ ] Состояния записи/отмены, очистка ресурсов
- [ ] Интеграционные тесты с моковым STT

### Фаза 4. UI-интеграция (плагин)
- [ ] Кнопка микрофона в чат (справа под полем ввода)
- [ ] Состояния UI: запись/стоп, распознавание, ошибка
- [ ] Подстановка текста в поле ввода (без авто-отправки)
- [ ] E2E сценарий: «нажал → проговорил → стоп → текст в поле»

### Фаза 5. Документация и релиз
- [ ] Обновить `docs/README.md` с инструкцией по конфигурации Yandex STT
- [ ] Пример переменных и секретов
- [ ] Changelog (при необходимости)

## Риски
- Доступ к микрофону/драйверы на разных ОС.
- Сетевая задержка/квоты Yandex Cloud.

## Критерии приемки
- Кнопка записи переключает состояния корректно.
- Текст появляется в поле ввода ≤ 3–5 сек после «Стоп» при нормальном соединении.
- Ошибки видны пользователю и логируются.
- Unit-тесты на парсинг/запросы и E2E сценарий UI пройдены.

## Ссылки
- Yandex SpeechKit STT v2 Quickstart: https://yandex.cloud/ru/docs/speechkit/quickstart/stt-quickstart-v2
- Пример сервиса из другого проекта (из условия)
