# ROADMAP: RAG — ссылки на источник чанка и открытие кода в редакторе

## Цели
 Сохранять ссылку на источник для каждого чанка при индексации.
 Протягивать ссылку и координаты через поиск/реранкинг до ответа RAG.
 Предоставлять в ответе RAG данные для открытия файла IDE на нужном месте.

## Принятые параметры
 Целевая платформа: IntelliJ/Android Studio.
 Действие: открыть файл (формат ссылки не критичен).
 Достаточно пути файла относительно корня проекта.
 Точность позиционирования: по строкам (`start_line`/`end_line`).
 Типа метаданных нет; данные относятся к текущему проекту.

## Критерии готовности (DoD)
 В метаданных чанка сохраняются поля: `path`, `start_line`, `end_line`.
 Поиск и реранкинг сохраняют и возвращают эти поля без потерь.
 DTO ответа чата (или RAG API) содержит массив результатов с полями источника и координатами.
 Действие по результату (клик/команда) открывает файл в IDE и позиционирует курсор/выделение по строкам.
 Покрыто тестами: unit/integ/E2E (минимум один сценарий сквозного открытия).
 Документация и `README` обновлены.
 Фича за фича-флагом; включение по конфигу.

## Объём работ
 Аудит текущего индексатора и хранилища эмбеддингов (формат метаданных).
 Изменение схемы метаданных и миграции хранилища (если требуется).
 Обновление индексатора: извлечение и сохранение координат и пути.
 Протяжка полей через пайплайн: поиск → реранкинг → сбор ответа.
 Расширение DTO/API: контракт ответа с источниками и позициями.
 Интеграция с IDE: открытие файла по пути и позиционирование по строкам.
 Тестирование (unit/integ/E2E) и документация.

## Предлагаемый формат ссылки
 Базовая форма (внутренняя команда или URI по необходимости): `open?path={ws_path}&startLine={n}&endLine={m}`.
 `path` — путь относительно корня workspace.
 `startLine`/`endLine` — 1-based позиционирование по строкам.
 Формат (URI vs internal-command) не принципиален, ключевое — корректное открытие файла в IDE.

## Изменения модели данных метаданных чанка
Предлагаем добавить/зафиксировать следующие поля (названия могут быть адаптированы к текущим типам):
 `path: String` — путь относительно корня проекта.
 `start_line: Int` / `end_line: Int` — диапазон строк чанка.

## Изменения API/DTO ответа RAG
 Расширить элемент результата (док/чанк) полями источника:
  - `source`: `path`, `startLine`, `endLine`.
  - `openAction` — вычисляемая команда/ссылка для IDE (использует поля выше).
 Гарантировать, что после реранкинга метаданные не теряются.

## Интеграция с IDE
 Целевая IDE: IntelliJ/Android Studio.
 Обработчик команды/URI открывает файл по `path` и позиционирует курсор на `startLine` (с выделением до `endLine`).
 При необходимости используется внутренняя команда IDE вместо URI.

## Тестирование
 Unit: сериализация/десериализация метаданных, корректность сборки действия открытия.
 Integ: индексация → поиск → реранкинг → ответ (валидность метаданных).
 E2E: клик по действию открывает файл и позиционирует курсор.

## Миграции и обратная совместимость
 Для существующих индексов: миграция полей по мере переиндексации.
 При отсутствии новых полей — UI скрывает кнопку/ссылку открытия.

## Фича-флаг
 Конфигурация: `rag.sourceLink.enabled=true`.
 Возможность включать отдельно: индексация полей и отображение в UI.

## Риски и план снижения
 Потеря метаданных при реранкинге → тесты и контракт передачи полей.
 Нестабильные пути/monorepo → хранить путь относительно workspace root.
 Различия IDE/ОС → использовать внутреннюю команду вместо общего URI при необходимости.

## Фазы выполнения

### Фаза 1 — Схема метаданных и индексатор
- [ ] Спецификация полей (`path`, `start_line`, `end_line`) и миграций.
- [ ] Реализация сохранения метаданных при индексации.
- [ ] Unit-тесты для индексатора и сериализации метаданных.

### Фаза 2 — Протяжка через поиск/реранкинг/ответ
- [ ] Транспортировка полей через конвейер (поиск → реранкинг → сбор ответа).
- [ ] Расширение DTO ответа (включить `source.path`, `source.startLine`, `source.endLine`).
- [ ] Интеграционные тесты пайплайна.

### Фаза 3 — Интеграция с IDE
- [ ] Обработчик действия открытия в IntelliJ/Android Studio (URI или внутренняя команда).
- [ ] E2E тест: клик по результату открывает файл и позиционирует курсор.

### Фаза 4 — Документация и фича-флаг
- [ ] Обновить документацию и `README`.
- [ ] Добавить конфигурационные флаги и провести поэтапный rollout.

## Примечания
 На первом этапе не используем `vcs_ref` и посимвольные смещения; при необходимости добавим в будущих итерациях.

