# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ EnhancedChatAgent –≤ –ø–ª–∞–≥–∏–Ω–µ

## –û–±–∑–æ—Ä

`EnhancedChatAgent` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á–∏ –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å–ø–æ—Å–æ–± –æ–±—Ä–∞–±–æ—Ç–∫–∏:
- **–ü—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã** ‚Üí –±–∞–∑–æ–≤—ã–π `ChatAgent` (–±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç)
- **–°–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏** ‚Üí `EnhancedAgentOrchestrator` (–º–Ω–æ–≥–æ—à–∞–≥–æ–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)

## –°–ø–æ—Å–æ–±—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –ß–µ—Ä–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–µ AgentFactory (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ó–∞–º–µ–Ω–∏—Ç–µ –≤ `ChatService.kt` —Å–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞:

```kotlin
// –ë—ã–ª–æ:
private var agent: Agent = AgentFactory.createChatAgent()

// –°—Ç–∞–ª–æ:
private var agent: Agent = AgentFactory.createEnhancedChatAgent()
```

**–§–∞–π–ª:** `src/main/kotlin/ru/marslab/ide/ride/service/ChatService.kt`  
**–°—Ç—Ä–æ–∫–∏:** 49, 619

### 2. –í—Ä–µ–º–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤ `PluginSettings`:

```kotlin
var useEnhancedAgent: Boolean = false
```

–ó–∞—Ç–µ–º –≤ `AgentFactory.createChatAgent()`:

```kotlin
fun createChatAgent(): Agent {
    val settings = service<PluginSettings>()
    
    // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω enhanced —Ä–µ–∂–∏–º
    if (settings.useEnhancedAgent) {
        return createEnhancedChatAgent()
    }
    
    // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
}
```

## –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –ü—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ChatAgent)

–≠—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã –ù–ï –¥–æ–ª–∂–Ω—ã –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä:

1. **"–ß—Ç–æ —Ç–∞–∫–æ–µ Kotlin?"**
   - –û–∂–∏–¥–∞–µ—Ç—Å—è: –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ "–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —à–∞–≥–∏"
   
2. **"–û–±—ä—è—Å–Ω–∏ –ø—Ä–∏–Ω—Ü–∏–ø SOLID"**
   - –û–∂–∏–¥–∞–µ—Ç—Å—è: –ø—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç –æ—Ç ChatAgent

3. **"–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç lateinit?"**
   - –û–∂–∏–¥–∞–µ—Ç—Å—è: –ø—Ä–æ—Å—Ç–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ

### –°–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Orchestrator)

–≠—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã –î–û–õ–ñ–ù–´ –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä:

1. **"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –∏ –Ω–∞–π–¥–∏ –≤—Å–µ –±–∞–≥–∏ –≤ –∫–æ–¥–µ"**
   - –û–∂–∏–¥–∞–µ—Ç—Å—è: 
     - –°–æ–æ–±—â–µ–Ω–∏–µ "## –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏"
     - –†–∞–∑–¥–µ–ª "### –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —à–∞–≥–∏:"
     - –ù–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

2. **"–ü—Ä–æ–≤–µ—Ä—å –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ –≤ –ø—Ä–æ–µ–∫—Ç–µ –∏ —Å–æ–∑–¥–∞–π –æ—Ç—á—ë—Ç"**
   - –û–∂–∏–¥–∞–µ—Ç—Å—è: –º–Ω–æ–≥–æ—à–∞–≥–æ–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º

3. **"–ù–∞–π–¥–∏ –æ—à–∏–±–∫–∏ –≤ —Ñ–∞–π–ª–µ Main.kt –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"**
   - –û–∂–∏–¥–∞–µ—Ç—Å—è: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞

4. **"–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞ –≤ –ø–∞–∫–µ—Ç–µ services"**
   - –û–∂–∏–¥–∞–µ—Ç—Å—è: —Å–ª–æ–∂–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

`EnhancedChatAgent` –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º:

### –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á:
- "–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π", "–Ω–∞–π–¥–∏ –±–∞–≥–∏", "–æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π"
- "—Ä–µ—Ñ–∞–∫—Ç–æ—Ä", "—Å–æ–∑–¥–∞–π –æ—Ç—á–µ—Ç", "–ø—Ä–æ–≤–µ—Ä—å –∫–∞—á–µ—Å—Ç–≤–æ"
- "–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä", "—Å–∫–∞–Ω–∏—Ä—É–π", "–∏—Å—Å–ª–µ–¥—É–π", "—É–ª—É—á—à–∏"

### –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤/–ø—Ä–æ–µ–∫—Ç–∞:
- "—Ñ–∞–π–ª", "–ø—Ä–æ–µ–∫—Ç", "–∫–æ–¥"

### –î–ª–∏–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞:
- –ó–∞–ø—Ä–æ—Å—ã > 100 —Å–∏–º–≤–æ–ª–æ–≤ —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º —Ñ–∞–π–ª–æ–≤ —Å—á–∏—Ç–∞—é—Ç—Å—è —Å–ª–æ–∂–Ω—ã–º–∏

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏:
- **BUG_FIX**: —Å–æ–¥–µ—Ä–∂–∏—Ç "–±–∞–≥", "–æ—à–∏–±–∫"
- **CODE_ANALYSIS**: —Å–æ–¥–µ—Ä–∂–∏—Ç "–∫–∞—á–µ—Å—Ç–≤", "code smell"
- **ARCHITECTURE_ANALYSIS**: —Å–æ–¥–µ—Ä–∂–∏—Ç "–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä"
- **REFACTORING**: —Å–æ–¥–µ—Ä–∂–∏—Ç "—Ä–µ—Ñ–∞–∫—Ç–æ—Ä"

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ IDE

### –®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–ª–∞–≥–∏–Ω

```bash
./gradlew runIde
```

### –®–∞–≥ 2: –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç

- –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ `Tools ‚Üí Ride Chat`
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å

### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã

#### –ü—Ä–æ—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å:
```
–ß—Ç–æ —Ç–∞–∫–æ–µ –∫–æ—Ä—É—Ç–∏–Ω—ã –≤ Kotlin?
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç
- –ù–ï–¢ —Ä–∞–∑–¥–µ–ª–∞ "–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —à–∞–≥–∏"
- –ù–ï–¢ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞

#### –°–ª–æ–∂–Ω–∞—è –∑–∞–¥–∞—á–∞:
```
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –∏ –Ω–∞–π–¥–∏ –≤—Å–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏ –≤ –∫–æ–¥–µ
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```markdown
## –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏

### –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —à–∞–≥–∏:
- üìã –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –°–æ–∑–¥–∞–Ω –ø–ª–∞–Ω –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–µ–∫—Ç–∞
- üîç –ó–∞–¥–∞—á–∞ 1: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
- üîç –ó–∞–¥–∞—á–∞ 2: –ü–æ–∏—Å–∫ –±–∞–≥–æ–≤
- ‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã: –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω

[–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞...]
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

–û—Ç–∫—Ä–æ–π—Ç–µ `Help ‚Üí Show Log in Files` –∏ –Ω–∞–π–¥–∏—Ç–µ:

```
EnhancedChatAgent processing request
Simple task, using base ChatAgent
```

–∏–ª–∏

```
EnhancedChatAgent processing request
Complex task detected, using orchestrator
```

## –û—Ç–ª–∞–¥–∫–∞

### –í–∫–ª—é—á–∏—Ç–µ debug –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í `EnhancedChatAgent.kt` –¥–æ–±–∞–≤—å—Ç–µ:

```kotlin
override suspend fun ask(request: AgentRequest): AgentResponse {
    logger.info("EnhancedChatAgent processing request: ${request.request}")
    
    val taskComplexity = analyzeTaskComplexity(request.request, request.context)
    logger.info("Task complexity: isComplex=${taskComplexity.isComplex}, " +
                "type=${taskComplexity.taskType}, " +
                "steps=${taskComplexity.estimatedSteps}")
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–∑–æ–≤—ã –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞

–î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `useOrchestrator`:

```kotlin
private suspend fun useOrchestrator(request: AgentRequest): AgentResponse {
    logger.info("Using orchestrator for complex task")
    val steps = mutableListOf<String>()
    // ...
}
```

## –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞–Ω–æ–≤:

### 1. –ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω –∑–∞–ø—Ä–æ—Å–∏—Ç—å –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```kotlin
val context = ChatContext(
    project = project,
    additionalContext = mapOf("resume_plan_id" to "plan-123")
)
```

### 2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
–î–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–π
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```markdown
## ‚úÖ –ü–ª–∞–Ω –≤–æ–∑–æ–±–Ω–æ–≤–ª—ë–Ω

### –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —à–∞–≥–∏:
- üìã –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –ü–ª–∞–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- üîç –ó–∞–¥–∞—á–∞ 3: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

[–†–µ–∑—É–ª—å—Ç–∞—Ç—ã...]
```

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–¢–µ—Å—Ç—ã —Å –º–æ–∫–∞–º–∏**: 2 –∏–∑ 9 —Ç–µ—Å—Ç–æ–≤ –ø–∞–¥–∞—é—Ç –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –º–æ–∫–∞–º–∏ `Project`
2. **UI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –ü–æ–∫–∞ –Ω–µ—Ç UI —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–≤–æ–¥–∞
3. **–ü—Ä–æ–≥—Ä–µ—Å—Å**: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ —á–∞—Ç–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. –ó–∞–º–µ–Ω–∏—Ç–µ `createChatAgent()` –Ω–∞ `createEnhancedChatAgent()` –≤ `ChatService`
2. –î–æ–±–∞–≤—å—Ç–µ UI —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–≤–æ–¥–∞
3. –†–µ–∞–ª–∏–∑—É–π—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
4. –î–æ–±–∞–≤—å—Ç–µ retry/loop –º–µ—Ö–∞–Ω–∏–∑–º—ã
5. –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ —Å UncertaintyAnalyzer

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ EnhancedChatAgent
./gradlew test --tests "ru.marslab.ide.ride.agent.impl.EnhancedChatAgentTest"

# –ó–∞–ø—É—Å–∫ –ø–ª–∞–≥–∏–Ω–∞ –≤ IDE
./gradlew runIde

# –°–±–æ—Ä–∫–∞ –ø–ª–∞–≥–∏–Ω–∞
./gradlew buildPlugin

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
tail -f build/idea-sandbox/system/log/idea.log | grep EnhancedChatAgent
```
