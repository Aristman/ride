# Диаграммы последовательности

## 1. Отправка сообщения пользователем

```
┌─────┐      ┌──────────┐       ┌────────────┐    ┌──────────┐    ┌──────────────┐      ┌─────────┐
│User │      │ChatPanel │       │ChatService │    │ChatAgent │    │LLMProvider   │      │Yandex   │
│     │      │          │       │            │    │          │    │              │      │GPT API  │
└──┬──┘      └────┬─────┘       └─────┬──────┘    └─────┬────┘    └──────┬───────┘      └────┬────┘
   │              │                   │                 │                │                   │
   │ Ввод текста  │                   │                 │                │                   │
   │ и нажатие    │                   │                 │                │                   │
   │ "Отправить"  │                   │                 │                │                   │
   ├─────────────>│                   │                 │                │                   │
   │              │                   │                 │                │                   │
   │              │ sendMessage()     │                 │                │                   │
   │              ├──────────────────>│                 │                │                   │
   │              │                   │                 │                │                   │
   │              │                   │ Сохранить       │                │                   │
   │              │                   │ сообщение       │                │                   │
   │              │                   │ пользователя    │                │                   │
   │              │                   │ в историю       │                │                   │
   │              │                   │                 │                │                   │
   │              │                   │ processRequest()│                │                   │
   │              │                   ├────────────────>│                │                   │
   │              │                   │                 │                │                   │
   │              │                   │                 │ Формирование   │                   │
   │              │                   │                 │ промпта с      │                   │
   │              │                   │                 │ контекстом     │                   │
   │              │                   │                 │                │                   │
   │              │                   │                 │ sendRequest()  │                   │
   │              │                   │                 ├───────────────>│                   │
   │              │                   │                 │                │                   │
   │              │                   │                 │                │ HTTP POST         │
   │              │                   │                 │                ├──────────────────>│
   │              │                   │                 │                │                   │
   │              │                   │                 │                │                   │
   │              │                   │                 │                │ JSON Response     │
   │              │                   │                 │                │<──────────────────┤
   │              │                   │                 │                │                   │
   │              │                   │                 │ LLMResponse    │                   │
   │              │                   │                 │<───────────────┤                   │
   │              │                   │                 │                │                   │
   │              │                   │ AgentResponse   │                │                   │
   │              │                   │<────────────────┤                │                   │
   │              │                   │                 │                │                   │
   │              │                   │ Сохранить       │                │                   │
   │              │                   │ ответ агента    │                │                   │
   │              │                   │ в историю       │                │                   │
   │              │                   │                 │                │                   │
   │              │ updateUI()        │                 │                │                   │
   │              │<──────────────────┤                 │                │                   │
   │              │                   │                 │                │                   │
   │ Отображение  │                   │                 │                │                   │
   │ ответа       │                   │                 │                │                   │
   │<─────────────┤                   │                 │                │                   │
   │              │                   │                 │                │                   │
```

## 2. Инициализация плагина

```
┌──────┐      ┌─────────────────┐       ┌────────────┐      ┌──────────────┐      ┌──────────┐
│IDE   │      │ChatToolWindow   │       │ChatService │      │PluginSettings│      │Agent     │
│      │      │Factory          │       │            │      │              │      │Factory   │
└───┬──┘      └────┬────────────┘       └─────┬──────┘      └──────┬───────┘      └────┬─────┘
    │              │                          │                    │                   │
    │ Запуск IDE   │                          │                    │                   │
    │              │                          │                    │                   │
    │ createToolWindow()                      │                    │                   │
    ├─────────────>│                          │                    │                   │
    │              │                          │                    │                   │
    │              │ getInstance()            │                    │                   │
    │              ├─────────────────────────>│                    │                   │
    │              │                          │                    │                   │
    │              │                          │ Инициализация      │                   │
    │              │                          │ сервиса            │                   │
    │              │                          │                    │                   │
    │              │                          │ loadState()        │                   │
    │              │                          ├───────────────────>│                   │
    │              │                          │                    │                   │
    │              │                          │ Settings           │                   │
    │              │                          │<───────────────────┤                   │
    │              │                          │                    │                   │
    │                                        │ createAgent()      │                   │
├────────────────────┼──────────────────>│
                             │                    │                   │
                             │                    │ Создание          │
                             │                    │ ChatAgent с       │
                             │                    │ LLMProvider       │
                             │                    │                   │
                             │ Agent              │                   │
                             │<───────────────────┼───────────────────┤
    │              │                          │                    │                   │
    │              │ ChatService              │                    │                   │
    │              │<─────────────────────────┤                    │                   │
    │              │                          │                    │                   │
    │              │ Создание ChatPanel       │                    │                   │
    │              │                          │                    │                   │
    │ ToolWindow   │                          │                    │                   │
    │<─────────────┤                          │                    │                   │
    │              │                          │                    │                   │
```

## 3. Обработка ошибки

```
┌──────────┐      ┌────────────┐      ┌──────────┐      ┌──────────────┐      ┌─────────┐
│ChatPanel │      │ChatService │      │ChatAgent │      │LLMProvider   │      │Yandex   │
│          │      │            │      │          │      │              │      │GPT API  │
└────┬─────┘      └─────┬──────┘      └─────┬────┘      └──────┬───────┘      └────┬────┘
     │                  │                  │                │                   │
     │ sendMessage()    │                  │                │                   │
     ├─────────────────>│                  │                │                   │
     │                  │                  │                │                   │
     │                  │ processRequest() │                │                   │
     │                  ├─────────────────>│                │                   │
     │                  │                  │                │                   │
     │                  │                  │ sendRequest()  │                   │
     │                  │                  ├───────────────>│                   │
     │                  │                  │                │                   │
     │                  │                  │                │ HTTP POST         │
     │                  │                  │                ├──────────────────>│
     │                  │                  │                │                   │
     │                  │                  │                │ 401 Unauthorized  │
     │                  │                  │                │<──────────────────┤
     │                  │                  │                │                   │
     │                  │                  │ Exception      │                   │
     │                  │                  │<───────────────┤                   │
     │                  │                  │                │                   │
     │                  │                  │ Логирование    │                   │
     │                  │                  │ ошибки         │                   │
     │                  │                  │                │                   │
     │                  │ AgentResponse    │                │                   │
     │                  │ (success=false)  │                │                   │
     │                  │<─────────────────┤                │                   │
     │                  │                  │                │                   │
     │                  │ Сохранить        │                │                   │
     │                  │ сообщение об     │                │                   │
     │                  │ ошибке           │                │                   │
     │                  │                  │                │                   │
     │ showError()      │                  │                │                   │
     │<─────────────────┤                  │                │                   │
     │                  │                  │                │                   │
     │ Показать         │                  │                │                   │
     │ уведомление      │                  │                │                   │
     │ об ошибке        │                  │                │                   │
     │                  │                  │                │                   │
```

## 4. Сохранение настроек

```
┌────┐      ┌────────────────────┐      ┌──────────────┐      ┌────────────┐
│User│      │SettingsConfigurable│      │PluginSettings│      │PasswordSafe│
│    │      │                    │      │              │      │            │
└─┬──┘      └─────────┬──────────┘      └──────┬───────┘      └─────┬──────┘
  │                   │                        │                    │
  │ Открыть Settings  │                        │                    │
  ├──────────────────>│                        │                    │
  │                   │                        │                    │
  │                   │ loadState()            │                    │
  │                   ├───────────────────────>│                    │
  │                   │                        │                    │
  │                   │                        │ getApiKey()        │
  │                   │                        ├───────────────────>│
  │                   │                        │                    │
  │                   │                        │ API Key            │
  │                   │                        │<───────────────────┤
  │                   │                        │                    │
  │                   │ Current Settings       │                    │
  │                   │<───────────────────────┤                    │
  │                   │                        │                    │
  │ Отображение       │                        │                    │
  │ текущих настроек  │                        │                    │
  │<──────────────────┤                        │                    │
  │                   │                        │                    │
  │ Изменение         │                        │                    │
  │ настроек          │                        │                    │
  ├──────────────────>│                        │                    │
  │                   │                        │                    │
  │                   │ Валидация              │                    │
  │                   │ введенных данных       │                    │
  │                   │                        │                    │
  │ Нажатие "Apply"   │                        │                    │
  ├──────────────────>│                        │                    │
  │                   │                        │                    │
  │                   │ apply()                │                    │
  │                   ├───────────────────────>│                    │
  │                   │                        │                    │
  │                   │                        │ saveApiKey()       │
  │                   │                        ├───────────────────>│
  │                   │                        │                    │
  │                   │                        │ Сохранение         │
  │                   │                        │ в безопасном       │
  │                   │                        │ хранилище          │
  │                   │                        │                    │
  │                   │                        │ Success            │
  │                   │                        │<───────────────────┤
  │                   │                        │                    │
  │                   │ Success                │                    │
  │                   │<───────────────────────┤                    │
  │                   │                        │                    │
  │ Уведомление       │                        │                    │
  │ "Settings saved"  │                        │                    │
  │<──────────────────┤                        │                    │
  │                   │                        │                    │
```

## 5. Получение истории сообщений

```
┌──────────┐      ┌────────────┐      ┌──────────────┐
│ChatPanel │      │ChatService │      │MessageHistory│
│          │      │            │      │              │
└────┬─────┘      └─────┬──────┘      └──────┬───────┘
     │                  │                    │
     │ Открытие         │                    │
     │ Tool Window      │                    │
     │                  │                    │
     │ loadHistory()    │                    │
     ├─────────────────>│                    │
     │                  │                    │
     │                  │ getMessages()      │
     │                  ├───────────────────>│
     │                  │                    │
     │                  │                    │ Получение
     │                  │                    │ сообщений
     │                  │                    │ из памяти
     │                  │                    │
     │                  │ List<Message>      │
     │                  │<───────────────────┤
     │                  │                    │
     │ List<Message>    │                    │
     │<─────────────────┤                    │
     │                  │                    │
     │ Отображение      │                    │
     │ истории в UI     │                    │
     │                  │                    │
```

## 6. Retry логика при ошибке сети

```
┌──────────────┐      ┌─────────┐
│LLMProvider   │      │Yandex   │
│              │      │GPT API  │
└──────┬───────┘      └────┬────┘
       │                   │
       │ HTTP POST         │
       │ (попытка 1)       │
       ├──────────────────>│
       │                   │
       │ Timeout / Error   │
       │<──────────────────┤
       │                   │
       │ Ожидание 1 сек    │
       │                   │
       │ HTTP POST         │
       │ (попытка 2)       │
       ├──────────────────>│
       │                   │
       │ Timeout / Error   │
       │<──────────────────┤
       │                   │
       │ Ожидание 2 сек    │
       │                   │
       │ HTTP POST         │
       │ (попытка 3)       │
       ├──────────────────>│
       │                   │
       │ Success Response  │
       │<──────────────────┤
       │                   │
```

## Примечания

### Асинхронность

Все операции с LLM выполняются асинхронно с использованием Kotlin Coroutines:

- `suspend` функции для сетевых запросов
- `Dispatchers.IO` для I/O операций
- `Dispatchers.Main` для обновления UI

### Обработка ошибок

На каждом уровне:

- **LLMProvider**: обрабатывает сетевые ошибки, возвращает `LLMError`
- **Agent**: обрабатывает ошибки провайдера, возвращает `AgentResponse` с флагом `success`
- **ChatService**: логирует ошибки, уведомляет UI
- **ChatPanel**: отображает ошибки пользователю

### Потокобезопасность

- `ChatService` - Application Service (singleton), потокобезопасный
- `MessageHistory` - использует thread-safe коллекции
- UI обновления только в EDT (Event Dispatch Thread)
