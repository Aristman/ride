# Интеграция Python MCP сервера файловой системы

## Обзор

В проект внедрен новый MCP (Model Context Protocol) сервер на Python для доступа к файловой системе, который заменяет предыдущую реализацию на Rust.

## Структура

### MCP сервер
- **Расположение**: `mcp-servers/filesystem-server/`
- **Язык**: Python 3.8+
- **Фреймворк**: FastAPI
- **Порт по умолчанию**: 3001

### Скрипты управления
- **Запуск**: `scripts/start-mcp-server.sh`
- **Остановка**: `scripts/stop-mcp-server.sh`

### Конфигурация
- **Файл конфигурации**: `.ride/mcp.json`
- **Переменные окружения**: настраиваются через `env` в конфигурации

## Возможности

### CRUD операции с файлами
- **Чтение файлов**: `GET /files/{path}`
- **Создание файлов**: `POST /files`
- **Обновление файлов**: `PUT /files/{path}`
- **Удаление файлов**: `DELETE /files/{path}`

### Операции с директориями
- **Чтение директорий**: `GET /directories/{path}`
- **Создание директорий**: `POST /directories`
- **Удаление директорий**: `DELETE /directories/{path}`

### Дополнительные функции
- **Пакетные операции**: `POST /batch`
- **Отслеживание изменений**: опционально через `watchdog`
- **Валидация путей**: защита от traversal атак
- **Ограничения**: максимальный размер файлов, разрешенные расширения

## Конфигурация

### .ride/mcp.json
```json
{
    "servers": [
        {
            "name": "filesystem-server",
            "type": "HTTP",
            "url": "http://127.0.0.1:3001",
            "enabled": true,
            "env": {
                "RIDE_FS_HOST": "127.0.0.1",
                "RIDE_FS_PORT": "3001",
                "RIDE_FS_BASE_DIR": "/path/to/project",
                "RIDE_FS_MAX_FILE_SIZE": "10485760",
                "RIDE_FS_ALLOWED_EXTENSIONS": "kt,java,py,js,ts,json,md,txt",
                "RIDE_FS_LOG_LEVEL": "info"
            }
        }
    ]
}
```

### Переменные окружения
- `RIDE_FS_HOST`: Хост для запуска сервера (по умолчанию: 127.0.0.1)
- `RIDE_FS_PORT`: Порт для запуска сервера (по умолчанию: 3001)
- `RIDE_FS_BASE_DIR`: Базовая директория для файловых операций
- `RIDE_FS_MAX_FILE_SIZE`: Максимальный размер файла в байтах
- `RIDE_FS_ALLOWED_EXTENSIONS`: Разрешенные расширения через запятую
- `RIDE_FS_LOG_LEVEL`: Уровень логирования (debug, info, warning, error)

## Интеграция с плагином

### Автоматический запуск
При открытии проекта плагин автоматически:
1. Проверяет конфигурацию MCP серверов
2. Запускает локальные серверы (filesystem-server)
3. Устанавливает подключение
4. Регистрирует доступные методы

### LocalMCPServerManager
Новый сервис для управления локальными MCP серверами:
- Запуск и остановка серверов
- Мониторинг процессов
- Управление статусами
- Обработка ошибок

### MCPConnectionManager
Обновлен для поддержки локальных серверов:
- Автоматический запуск при необходимости
- Интеграция с LocalMCPServerManager
- Правильное завершение при закрытии проекта

## API

### Health check
```
GET /health
```

### Файловые операции
```
GET /files/{path}           - Чтение файла
POST /files                 - Создание файла
PUT /files/{path}           - Обновление файла
DELETE /files/{path}        - Удаление файла
```

### Операции с директориями
```
GET /directories/{path}     - Чтение директории
POST /directories           - Создание директории
DELETE /directories/{path}  - Удаление директории
```

### Пакетные операции
```
POST /batch                 - Множественные операции
```

## Безопасность

### Защита от traversal атак
- Валидация и нормализация путей
- Проверка на выход за пределы базовой директории
- Блокировка опасных путей

### Ограничения
- Максимальный размер файлов
- Белый список расширений
- Черный список путей
- Контроль доступа

## Установка и запуск

### Требования
- Python 3.8+
- pip для установки зависимостей

### Автоматический запуск
Плагин автоматически запускает MCP сервер при открытии проекта.

### Ручной запуск
```bash
# Запуск
./scripts/start-mcp-server.sh

# Остановка
./scripts/stop-mcp-server.sh
```

### Установка зависимостей
```bash
cd mcp-servers/filesystem-server
pip install -e .
```

## Логирование

### Уровни логирования
- `debug`: Детальная отладочная информация
- `info`: Общая информация о работе сервера
- `warning`: Предупреждения
- `error`: Ошибки

### Просмотр логов
Логи MCP сервера доступны в:
- IDE Event Log
- Консоль при запуске через скрипты

## Тестирование

### Запуск тестов
```bash
cd mcp-servers/filesystem-server
pytest
```

### Тесты API
Сервер предоставляет автоматическую документацию:
- Swagger UI: `http://127.0.0.1:3001/docs`
- ReDoc: `http://127.0.0.1:3001/redoc`

## Устранение неисправностей

### Ошибки запуска
1. Проверьте наличие Python 3.8+
2. Установите зависимости: `pip install fastapi uvicorn aiofiles`
3. Проверьте права доступа к скриптам: `chmod +x scripts/*.sh`

### Проблемы с подключением
1. Проверьте, что сервер запущен: `lsof -i :3001`
2. Проверьте конфигурацию в `.ride/mcp.json`
3. Посмотрите логи в IDE Event Log

### Ошибки доступа к файлам
1. Проверьте `RIDE_FS_BASE_DIR`
2. Убедитесь, что путь в разрешенных директориях
3. Проверьте расширение файла в `RIDE_FS_ALLOWED_EXTENSIONS`

## Дальнейшее развитие

### Планируемые улучшения
- Поддержка Symbolic links
- Расширенные операции поиска
- Интеграция с системой индексации файлов
- Кэширование файловых операций
- Поддержка сетевых файловых систем

### Расширение API
- Метаданные файлов
- Операции копирования/перемещения
- Работа с архивами
- Мониторинг файловой системы